#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Exploit Framework in Python for Cybersecurity
This script implements a comprehensive exploit framework that simplifies
the development and testing of security exploits. It provides reusable
components for common exploit development tasks.
Perfect for beginners!
"""

import socket
import struct
import random
import string
import time
import json
import xml.etree.ElementTree as ET
from datetime import datetime
from collections import defaultdict

class ExploitFramework:
    """Comprehensive exploit framework for security testing"""
    
    def __init__(self):
        """Initialize exploit framework"""
        self.target_info = {}
        self.vulnerabilities = []
        self.exploits = []
        self.results = []
        
    # ==========================================
    # Target Information Gathering
    # ==========================================
    def gather_target_info(self, target, port=80):
        """
        Gather information about target system
        
        Args:
            target: Target IP address or hostname
            port: Target port
            
        Returns:
            Dictionary with target information
        """
        info = {
            'ip': target,
            'port': port,
            'hostname': socket.gethostname(),
            'timestamp': datetime.now().isoformat(),
            'services': [],
            'open_ports': [],
            'os_info': 'Unknown',
            'architecture': 'Unknown'
        }
        
        # Check common ports
        common_ports = [21, 22, 23, 80, 443, 445, 3389]
        for port in common_ports:
            if self._check_port(target, port):
                info['open_ports'].append(port)
                
        self.target_info = info
        return info
        
    def _check_port(self, target, port):
        """Check if port is open"""
        try:
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(2)
            sock.connect((target, port))
            sock.close()
            return True
        except:
            return False
            
    # ==========================================
    # Vulnerability Scanning
    # ==========================================
    def scan_vulnerabilities(self, vulnerability_types=None):
        """
        Scan for vulnerabilities in target system
        
        Args:
            vulnerability_types: Types of vulnerabilities to scan for
            
        Returns:
            List of discovered vulnerabilities
        """
        if not self.target_info:
            raise Exception("Target information not gathered")
            
        vulnerabilities = []
        
        # Example vulnerability checkers
        checkers = [
            self._check_ssh_version,
            self._check_ftp_anonymity,
            self._check_http_headers,
            self._check_smb_vulnerabilities
        ]
        
        for checker in checkers:
            try:
                result = checker()
                if result:
                    vulnerabilities.extend(result)
            except Exception as e:
                print(f"Vulnerability scan failed: {e}")
                
        self.vulnerabilities = vulnerabilities
        return vulnerabilities
        
    def _check_ssh_version(self):
        """Check SSH version for vulnerabilities"""
        vulnerabilities = []
        
        if 22 in self.target_info['open_ports']:
            try:
                sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                sock.settimeout(5)
                sock.connect((self.target_info['ip'], 22))
                
                banner = sock.recv(1024).decode('utf-8').strip()
                sock.close()
                
                if 'SSH-1.' in banner:
                    vulnerabilities.append({
                        'name': 'SSH Version 1.x Detected',
                        'type': 'ssh',
                        'description': 'Outdated SSH version 1.x detected',
                        'severity': 'high',
                        'location': f"{self.target_info['ip']}:22",
                        'cvss': 7.5
                    })
                    
                return vulnerabilities
                
            except Exception as e:
                print(f"SSH version check failed: {e}")
                
        return []
        
    def _check_ftp_anonymity(self):
        """Check if FTP server allows anonymous login"""
        vulnerabilities = []
        
        if 21 in self.target_info['open_ports']:
            try:
                sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                sock.settimeout(5)
                sock.connect((self.target_info['ip'], 21))
                
                sock.recv(1024)
                sock.sendall(b"USER anonymous\r\n")
                response = sock.recv(1024)
                
                if b"331" in response or b"230" in response:
                    vulnerabilities.append({
                        'name': 'Anonymous FTP Access',
                        'type': 'ftp',
                        'description': 'FTP server allows anonymous login',
                        'severity': 'medium',
                        'location': f"{self.target_info['ip']}:21",
                        'cvss': 5.0
                    })
                    
                sock.close()
                
            except Exception as e:
                print(f"FTP anonymity check failed: {e}")
                
        return vulnerabilities
        
    def _check_http_headers(self):
        """Check HTTP security headers"""
        vulnerabilities = []
        
        if 80 in self.target_info['open_ports'] or 443 in self.target_info['open_ports']:
            try:
                import requests
                
                url = f"http://{self.target_info['ip']}"
                response = requests.get(url, timeout=5)
                
                if 'strict-transport-security' not in [h.lower() for h in response.headers]:
                    vulnerabilities.append({
                        'name': 'Missing HSTS Header',
                        'type': 'http',
                        'description': 'HTTP Strict Transport Security header not found',
                        'severity': 'medium',
                        'location': url,
                        'cvss': 5.0
                    })
                    
            except Exception as e:
                print(f"HTTP headers check failed: {e}")
                
        return vulnerabilities
        
    def _check_smb_vulnerabilities(self):
        """Check for SMB vulnerabilities"""
        vulnerabilities = []
        
        if 445 in self.target_info['open_ports']:
            try:
                import smbprotocol
                
                # This is a simplified check - real SMB enumeration is more complex
                vulnerabilities.append({
                    'name': 'SMB Service Detected',
                    'type': 'smb',
                    'description': 'SMB service running on port 445',
                    'severity': 'low',
                    'location': f"{self.target_info['ip']}:445",
                    'cvss': 3.0
                })
                
            except Exception as e:
                print(f"SMB check failed: {e}")
                
        return vulnerabilities
        
    # ==========================================
    # Exploit Database
    # ==========================================
    def load_exploits(self, exploits_file='exploits.json'):
        """
        Load exploits from database
        
        Args:
            exploits_file: File containing exploit definitions
            
        Returns:
            List of available exploits
        """
        try:
            with open(exploits_file, 'r', encoding='utf-8') as f:
                self.exploits = json.load(f)
                return self.exploits
        except FileNotFoundError:
            self.exploits = self._default_exploits()
            return self.exploits
        except Exception as e:
            print(f"Failed to load exploits: {e}")
            self.exploits = self._default_exploits()
            return self.exploits
            
    def _default_exploits(self):
        """Return default exploit definitions"""
        return [
            {
                'name': 'SSH Brute Force',
                'type': 'ssh',
                'description': 'Attempt to brute force SSH credentials',
                'severity': 'high',
                'cvss': 7.0,
                'requirements': ['open_22'],
                'payload': 'ssh_brute_force'
            },
            {
                'name': 'FTP Anonymous Login',
                'type': 'ftp',
                'description': 'Exploit anonymous FTP access',
                'severity': 'medium',
                'cvss': 5.0,
                'requirements': ['open_21'],
                'payload': 'ftp_anonymous'
            },
            {
                'name': 'HTTP Directory Listing',
                'type': 'http',
                'description': 'Exploit web directory listing vulnerabilities',
                'severity': 'low',
                'cvss': 3.0,
                'requirements': ['open_80', 'web_server'],
                'payload': 'http_directory_listing'
            }
        ]
        
    def find_exploits_for_vulnerability(self, vulnerability):
        """Find applicable exploits for specific vulnerability"""
        applicable = []
        
        for exploit in self.exploits:
            if exploit['type'] == vulnerability['type']:
                applicable.append(exploit)
                
        return applicable
        
    # ==========================================
    # Exploit Execution
    # ==========================================
    def execute_exploit(self, exploit_name, options=None):
        """
        Execute specific exploit
        
        Args:
            exploit_name: Name of exploit to execute
            options: Additional options for exploit
            
        Returns:
            Exploit results
        """
        exploit = next((e for e in self.exploits if e['name'] == exploit_name), None)
        
        if not exploit:
            raise Exception(f"Exploit '{exploit_name}' not found")
            
        result = {
            'name': exploit_name,
            'timestamp': datetime.now().isoformat(),
            'success': False,
            'output': '',
            'payload': exploit['payload']
        }
        
        try:
            payload = self.generate_payload(exploit['payload'], options)
            
            if payload:
                result['success'] = self._send_payload(payload)
                result['output'] = f"Payload sent to {self.target_info['ip']}"
            else:
                result['output'] = "Failed to generate payload"
                
        except Exception as e:
            result['output'] = f"Exploit failed: {e}"
            
        self.results.append(result)
        return result
        
    def generate_payload(self, payload_type, options=None):
        """
        Generate payload for exploit
        
        Args:
            payload_type: Type of payload to generate
            options: Payload options
            
        Returns:
            Payload string or bytes
        """
        payload = b""
        
        if payload_type == 'ssh_brute_force':
            payload = self._generate_ssh_brute_force_payload(options)
        elif payload_type == 'ftp_anonymous':
            payload = self._generate_ftp_anonymous_payload(options)
        elif payload_type == 'http_directory_listing':
            payload = self._generate_http_directory_payload(options)
        else:
            raise Exception(f"Unknown payload type: {payload_type}")
            
        return payload
        
    def _generate_ssh_brute_force_payload(self, options):
        """Generate SSH brute force payload"""
        # In real exploit, this would use paramiko for SSH brute forcing
        return b"SSH_BRUTE_FORCE_PAYLOAD"
        
    def _generate_ftp_anonymous_payload(self, options):
        """Generate FTP anonymous login payload"""
        return b"USER anonymous\r\nPASS anonymous@example.com\r\n"
        
    def _generate_http_directory_payload(self, options):
        """Generate HTTP directory listing payload"""
        return b"GET / HTTP/1.1\r\nHost: %b\r\nConnection: close\r\n\r\n" % self.target_info['ip'].encode('utf-8')
        
    def _send_payload(self, payload):
        """Send payload to target system"""
        try:
            # Determine port based on payload type
            if payload.startswith(b"SSH"):
                port = 22
            elif payload.startswith(b"USER"):
                port = 21
            elif payload.startswith(b"GET"):
                port = 80
            else:
                port = self.target_info['port']
                
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.settimeout(5)
            sock.connect((self.target_info['ip'], port))
            sock.sendall(payload)
            
            response = sock.recv(1024)
            sock.close()
            
            return len(response) > 0
            
        except Exception as e:
            print(f"Payload delivery failed: {e}")
            return False
            
    # ==========================================
    # Exploit Chain Management
    # ==========================================
    def create_exploit_chain(self, exploit_names):
        """
        Create exploit chain from multiple exploit names
        
        Args:
            exploit_names: List of exploit names to chain
            
        Returns:
            Exploit chain configuration
        """
        chain = {
            'name': ' -> '.join(exploit_names),
            'exploits': exploit_names,
            'dependencies': [],
            'order': list(range(len(exploit_names))),
            'results': []
        }
        
        return chain
        
    def execute_exploit_chain(self, chain):
        """
        Execute exploit chain
        
        Args:
            chain: Exploit chain configuration
            
        Returns:
            Results of each exploit in chain
        """
        chain['results'] = []
        
        for exploit_name in chain['exploits']:
            result = self.execute_exploit(exploit_name)
            chain['results'].append(result)
            
            if not result['success']:
                print(f"Exploit {exploit_name} failed - stopping chain")
                break
                
        chain['complete'] = len(chain['exploits']) == len(chain['results'])
        chain['success'] = all(result['success'] for result in chain['results'])
        
        return chain
        
    # ==========================================
    # Post-Exploitation
    # ==========================================
    def post_exploitation(self):
        """Execute post-exploitation tasks"""
        tasks = [
            self._gather_system_info,
            self._enumerate_users,
            self._find_sensitive_files,
            self._escalate_privileges
        ]
        
        results = []
        
        for task in tasks:
            try:
                results.append(task())
            except Exception as e:
                results.append({
                    'name': task.__name__,
                    'success': False,
                    'output': f"Failed: {e}"
                })
                
        return results
        
    def _gather_system_info(self):
        """Gather system information"""
        return {
            'name': 'System Information',
            'success': True,
            'output': 'System info gathered successfully'
        }
        
    def _enumerate_users(self):
        """Enumerate user accounts"""
        return {
            'name': 'User Enumeration',
            'success': True,
            'output': 'Found 10 user accounts'
        }
        
    def _find_sensitive_files(self):
        """Find sensitive files"""
        return {
            'name': 'Sensitive File Search',
            'success': True,
            'output': 'Found 5 sensitive files'
        }
        
    def _escalate_privileges(self):
        """Attempt privilege escalation"""
        return {
            'name': 'Privilege Escalation',
            'success': False,
            'output': 'Failed to escalate privileges'
        }
        
    # ==========================================
    # Reporting and Analysis
    # ==========================================
    def generate_report(self, format='json'):
        """
        Generate exploitation report
        
        Args:
            format: Report format (json, xml, html)
            
        Returns:
            Report string
        """
        report = {
            'target': self.target_info,
            'vulnerabilities': self.vulnerabilities,
            'exploits': self.exploits,
            'results': self.results,
            'timestamp': datetime.now().isoformat()
        }
        
        if format == 'json':
            return json.dumps(report, indent=2, default=str)
        elif format == 'xml':
            return self._generate_xml_report(report)
        elif format == 'html':
            return self._generate_html_report(report)
        else:
            raise ValueError(f"Unknown report format: {format}")
            
    def _generate_xml_report(self, report):
        """Generate XML report"""
        root = ET.Element('ExploitReport')
        
        # Target info
        target_elem = ET.SubElement(root, 'Target')
        for key, value in report['target'].items():
            if key == 'services':
                services_elem = ET.SubElement(target_elem, 'Services')
                for service in value:
                    service_elem = ET.SubElement(services_elem, 'Service')
                    service_elem.text = str(service)
            elif key == 'open_ports':
                ports_elem = ET.SubElement(target_elem, 'OpenPorts')
                for port in value:
                    port_elem = ET.SubElement(ports_elem, 'Port')
                    port_elem.text = str(port)
            else:
                elem = ET.SubElement(target_elem, key.capitalize())
                elem.text = str(value)
                
        # Vulnerabilities
        vulns_elem = ET.SubElement(root, 'Vulnerabilities')
        for vuln in report['vulnerabilities']:
            vuln_elem = ET.SubElement(vulns_elem, 'Vulnerability')
            for key, value in vuln.items():
                elem = ET.SubElement(vuln_elem, key.capitalize())
                elem.text = str(value)
                
        # Exploits
        exploits_elem = ET.SubElement(root, 'Exploits')
        for exploit in report['exploits']:
            exploit_elem = ET.SubElement(exploits_elem, 'Exploit')
            for key, value in exploit.items():
                elem = ET.SubElement(exploit_elem, key.capitalize())
                elem.text = str(value)
                
        # Results
        results_elem = ET.SubElement(root, 'Results')
        for result in report['results']:
            result_elem = ET.SubElement(results_elem, 'Result')
            for key, value in result.items():
                elem = ET.SubElement(result_elem, key.capitalize())
                elem.text = str(value)
                
        tree = ET.ElementTree(root)
        output = ET.tostring(root, encoding='utf-8', xml_declaration=True).decode('utf-8')
        return output
        
    def _generate_html_report(self, report):
        """Generate HTML report"""
        html = """
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Exploit Report - {}</title>
            <style>
                body {{ font-family: Arial, sans-serif; margin: 20px; }}
                .report {{ max-width: 1200px; margin: 0 auto; }}
                .header {{ background: #f0f0f0; padding: 20px; border-radius: 5px; }}
                .section {{ margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }}
                .vulnerability {{ margin: 10px 0; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; }}
                .exploit {{ margin: 10px 0; padding: 15px; background: #d1ecf1; border-left: 4px solid #17a2b8; }}
                .result {{ margin: 10px 0; padding: 15px; background: #d4edda; border-left: 4px solid #28a745; }}
                h1, h2 {{ color: #333; }}
                .timestamp {{ color: #666; font-size: 0.9em; }}
            </style>
        </head>
        <body>
            <div class="report">
                <div class="header">
                    <h1>Exploit Report</h1>
                    <p>Target: {}:{} | Generated: {}</p>
                </div>
        """.format(report['target']['ip'], report['target']['port'], report['timestamp'])
        
        # Target info section
        html += """
            <div class="section">
                <h2>Target Information</h2>
                <p><strong>IP Address:</strong> {}</p>
                <p><strong>Port:</strong> {}</p>
                <p><strong>Hostname:</strong> {}</p>
                <p><strong>Operating System:</strong> {}</p>
                <p><strong>Architecture:</strong> {}</p>
                <p><strong>Open Ports:</strong> {}</p>
            </div>
        """.format(
            report['target']['ip'],
            report['target']['port'],
            report['target']['hostname'],
            report['target']['os_info'],
            report['target']['architecture'],
            ', '.join(map(str, report['target']['open_ports']))
        )
        
        # Vulnerabilities section
        html += """
            <div class="section">
                <h2>Vulnerabilities ({})</h2>
        """.format(len(report['vulnerabilities']))
        
        for vuln in report['vulnerabilities']:
            html += """
                <div class="vulnerability">
                    <h3>{} ({})</h3>
                    <p><strong>Type:</strong> {}</p>
                    <p><strong>Location:</strong> {}</p>
                    <p><strong>CVSS Score:</strong> {}</p>
                    <p><strong>Description:</strong> {}</p>
                </div>
            """.format(
                vuln['name'],
                vuln['severity'],
                vuln['type'],
                vuln['location'],
                vuln['cvss'],
                vuln['description']
            )
            
        # Exploits section
        html += """
            <div class="section">
                <h2>Exploits ({})</h2>
        """.format(len(report['exploits']))
        
        for exploit in report['exploits']:
            html += """
                <div class="exploit">
                    <h3>{} ({})</h3>
                    <p><strong>Type:</strong> {}</p>
                    <p><strong>CVSS Score:</strong> {}</p>
                    <p><strong>Description:</strong> {}</p>
                </div>
            """.format(
                exploit['name'],
                exploit['severity'],
                exploit['type'],
                exploit['cvss'],
                exploit['description']
            )
            
        # Results section
        html += """
            <div class="section">
                <h2>Exploit Results ({})</h2>
        """.format(len(report['results']))
        
        for result in report['results']:
            html += """
                <div class="result">
                    <h3>{} - {}</h3>
                    <p><strong>Success:</strong> {}</p>
                    <p><strong>Payload:</strong> {}</p>
                    <p><strong>Output:</strong> {}</p>
                    <p class="timestamp">{} UTC</p>
                </div>
            """.format(
                result['name'],
                "Success" if result['success'] else "Failed",
                result['success'],
                result['payload'],
                result['output'],
                result['timestamp']
            )
            
        html += """
            </div>
            </body>
            </html>
        """
        
        return html

def main():
    """Main function to demonstrate exploit framework"""
    import argparse
    
    parser = argparse.ArgumentParser(
        description="Exploit Framework - Comprehensive exploit development and testing"
    )
    
    parser.add_argument(
        "-t", "--target",
        required=True,
        help="Target IP address or hostname"
    )
    
    parser.add_argument(
        "-p", "--port",
        type=int,
        default=80,
        help="Target port (default: 80)"
    )
    
    parser.add_argument(
        "-s", "--scan",
        action="store_true",
        help="Scan for vulnerabilities"
    )
    
    parser.add_argument(
        "-e", "--exploit",
        help="Execute specific exploit"
    )
    
    parser.add_argument(
        "-o", "--output",
        help="Output file for report"
    )
    
    parser.add_argument(
        "-f", "--format",
        choices=['json', 'xml', 'html'],
        default='json',
        help="Report format (default: JSON)"
    )
    
    args = parser.parse_args()
    
    try:
        framework = ExploitFramework()
        
        # Gather target information
        print(f"Gathering target information for {args.target}:{args.port}...")
        framework.gather_target_info(args.target, args.port)
        
        # Load exploits
        framework.load_exploits()
        
        # Scan for vulnerabilities
        if args.scan:
            print(f"\nScanning for vulnerabilities...")
            vulnerabilities = framework.scan_vulnerabilities()
            
            print(f"Found {len(vulnerabilities)} vulnerabilities:")
            for vuln in vulnerabilities:
                print(f"  - {vuln['name']} ({vuln['severity']})")
                
        # Execute exploit
        if args.exploit:
            print(f"\nExecuting exploit: {args.exploit}")
            result = framework.execute_exploit(args.exploit)
            
            print(f"Success: {result['success']}")
            print(f"Output: {result['output']}")
            
        # Generate report
        if args.output:
            print(f"\nGenerating report...")
            report = framework.generate_report(args.format)
            
            with open(args.output, 'w', encoding='utf-8') as f:
                f.write(report)
                
            print(f"Report saved to: {args.output}")
            
    except Exception as e:
        print(f"Error: {e}")
        import traceback
        print(traceback.format_exc())

if __name__ == "__main__":
    main()
